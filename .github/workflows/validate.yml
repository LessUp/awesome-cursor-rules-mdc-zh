name: éªŒè¯ç¿»è¯‘æ–‡ä»¶

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: éªŒè¯ MDC æ–‡ä»¶æ ¼å¼
      run: npm run validate

    - name: ç»Ÿè®¡ç¿»è¯‘è¿›åº¦
      run: npm run progress

    - name: æ£€æŸ¥ YAML æ ¼å¼
      run: |
        echo "æ£€æŸ¥ YAML å‰ç½®å…ƒæ•°æ®æ ¼å¼..."
        node -e "
        const fs = require('fs');
        const yaml = require('js-yaml');
        const path = require('path');
        
        const rulesDir = 'rules-mdc-zh';
        const files = fs.readdirSync(rulesDir).filter(f => f.endsWith('.mdc'));
        
        let hasErrors = false;
        files.forEach(file => {
          const content = fs.readFileSync(path.join(rulesDir, file), 'utf8');
          const parts = content.split('---\\n');
          if (parts.length < 3) {
            console.error(\`âŒ \${file}: ç¼ºå°‘ YAML å‰ç½®å…ƒæ•°æ®\`);
            hasErrors = true;
            return;
          }
          
          try {
            const yamlContent = parts[1];
            const parsed = yaml.load(yamlContent);
            if (!parsed.description || !parsed.globs) {
              console.error(\`âŒ \${file}: YAML ç¼ºå°‘å¿…éœ€å­—æ®µ\`);
              hasErrors = true;
            } else {
              console.log(\`âœ… \${file}: YAML æ ¼å¼æ­£ç¡®\`);
            }
          } catch (error) {
            console.error(\`âŒ \${file}: YAML è§£æé”™è¯¯ - \${error.message}\`);
            hasErrors = true;
          }
        });
        
        if (hasErrors) {
          process.exit(1);
        }
        console.log('ğŸ‰ æ‰€æœ‰æ–‡ä»¶ YAML æ ¼å¼éªŒè¯é€šè¿‡ï¼');
        "

    - name: æ£€æŸ¥ç¿»è¯‘ä¸€è‡´æ€§
      run: |
        echo "æ£€æŸ¥æŠ€æœ¯æœ¯è¯­ç¿»è¯‘ä¸€è‡´æ€§..."
        node -e "
        const fs = require('fs');
        const path = require('path');
        
        // è¯»å–æœ¯è¯­è¯å…¸
        const terminologyPath = 'docs/terminology.md';
        if (!fs.existsSync(terminologyPath)) {
          console.log('âš ï¸ æœ¯è¯­è¯å…¸ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¸€è‡´æ€§æ£€æŸ¥');
          process.exit(0);
        }
        
        console.log('âœ… æœ¯è¯­è¯å…¸å­˜åœ¨ï¼Œç¿»è¯‘ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡');
        "

    - name: ç”Ÿæˆç¿»è¯‘æŠ¥å‘Š
      run: |
        echo "## ğŸ“Š ç¿»è¯‘è¿›åº¦æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        npm run progress 2>&1 | grep -E "(æ€»æ–‡ä»¶æ•°|å·²ç¿»è¯‘|å¾…ç¿»è¯‘|ç¿»è¯‘å®Œæˆåº¦|åˆ†ç±»ç»Ÿè®¡)" >> $GITHUB_STEP_SUMMARY || true
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ Actions æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: æ£€æŸ¥æ–‡ä»¶ç¼–ç 
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶ç¼–ç æ ¼å¼..."
        find rules-mdc-zh -name "*.mdc" -exec file {} \; | grep -v "UTF-8" && exit 1 || echo "âœ… æ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯ UTF-8 ç¼–ç "

    - name: æ£€æŸ¥æ–‡ä»¶å¤§å°
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å¤§å°..."
        find rules-mdc-zh -name "*.mdc" -size +100k -exec echo "âš ï¸ æ–‡ä»¶è¿‡å¤§: {}" \;
        echo "âœ… æ–‡ä»¶å¤§å°æ£€æŸ¥å®Œæˆ"

    - name: æ£€æŸ¥é‡å¤å†…å®¹
      run: |
        echo "æ£€æŸ¥é‡å¤å†…å®¹..."
        # ç®€å•çš„é‡å¤æ£€æŸ¥
        find rules-mdc-zh -name "*.mdc" -exec basename {} \; | sort | uniq -d | while read file; do
          echo "âš ï¸ å‘ç°é‡å¤æ–‡ä»¶å: $file"
        done
        echo "âœ… é‡å¤å†…å®¹æ£€æŸ¥å®Œæˆ"
